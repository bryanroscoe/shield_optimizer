# Shield-Optimizer CI Tests
# Runs Pester unit tests on push and PR across Windows, macOS, and Linux

name: Tests

on:
  push:
    branches: [main]
    paths:
      - 'Shield-Optimizer.ps1'
      - 'tests/**'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'Shield-Optimizer.ps1'
      - 'tests/**'
      - '.github/workflows/tests.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -MinimumVersion 5.0 -Force -SkipPublisherCheck

      - name: Run Pester tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = "./tests/"
          $config.Output.Verbosity = "Detailed"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "test-results.xml"
          $config.TestResult.OutputFormat = "NUnitXml"

          $result = Invoke-Pester -Configuration $config

          if ($result.FailedCount -gt 0) {
            Write-Error "Tests failed: $($result.FailedCount) failures"
            exit 1
          }

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}
          path: test-results.xml

  lint:
    name: PowerShell Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check PowerShell syntax
        shell: pwsh
        run: |
          $errors = $null
          [System.Management.Automation.Language.Parser]::ParseFile(
            'Shield-Optimizer.ps1',
            [ref]$null,
            [ref]$errors
          ) | Out-Null

          if ($errors.Count -gt 0) {
            $errors | ForEach-Object { Write-Error $_.ToString() }
            exit 1
          }
          Write-Host "Syntax check passed" -ForegroundColor Green
